<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - EEBC</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            font-size: 11px;
            color: #0B0F19;
            background: #fff;
        }
        
        /* Navigation - masqu√©e √† l'impression */
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .nav-controls a, .nav-controls button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 13px;
            border: none;
            cursor: pointer;
        }
        
        .btn-outline {
            background: #fff;
            color: #0B0F19;
            border: 1px solid #cbd5e1;
        }
        
        .btn-outline:hover, .btn-outline.active {
            background: #0A36FF;
            color: #fff;
            border-color: #0A36FF;
        }
        
        .btn-success {
            background: #10b981;
            color: #fff;
        }
        
        /* Page du calendrier */
        .calendar-page {
            width: 297mm;
            height: 210mm;
            padding: 8mm;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* En-t√™te compact */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 5px;
            border-bottom: 2px solid #0A36FF;
            margin-bottom: 5px;
            height: 25px;
        }
        
        .page-header h1 {
            font-size: 14px;
            color: #0A36FF;
            font-weight: 700;
        }
        
        .page-header .church {
            font-size: 10px;
            color: #64748b;
        }
        
        /* Titre du mois */
        .month-title {
            background: linear-gradient(135deg, #0A36FF 0%, #3b82f6 100%);
            color: #fff;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            border-radius: 4px 4px 0 0;
        }
        
        /* Tableau calendrier - OPTIMIS√â POUR 1 PAGE */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .calendar-table th {
            background: #f1f5f9;
            padding: 4px 2px;
            text-align: center;
            font-weight: 600;
            font-size: 9px;
            color: #475569;
            border: 1px solid #e2e8f0;
            text-transform: uppercase;
        }
        
        .calendar-table td {
            border: 1px solid #e2e8f0;
            vertical-align: top;
            padding: 2px;
            height: 28mm;
            background: #fff;
            overflow: hidden;
        }
        
        .calendar-table td.empty {
            background: #f8fafc;
        }
        
        .day-number {
            font-weight: 700;
            font-size: 11px;
            color: #0B0F19;
            margin-bottom: 1px;
        }
        
        .day-events {
            overflow: hidden;
        }
        
        .event-item {
            font-size: 8px;
            padding: 2px 3px;
            margin-bottom: 2px;
            border-radius: 2px;
            color: #fff;
            line-height: 1.2;
            overflow: hidden;
        }
        
        .event-time {
            font-weight: 700;
        }
        
        .event-title {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .event-location {
            font-size: 7px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .more-events {
            font-size: 7px;
            color: #64748b;
            text-align: center;
        }
        
        /* L√©gende compacte */
        .legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding: 4px 0;
            font-size: 8px;
            color: #64748b;
            border-top: 1px solid #e2e8f0;
            margin-top: 3px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        
        /* MODE TRIMESTRE - 3 mois sur 3 pages */
        .quarter-mode .calendar-table td {
            height: 26mm;
        }
        
        .quarter-mode .event-item {
            font-size: 7px;
            padding: 1px 2px;
            margin-bottom: 1px;
        }
        
        .quarter-mode .event-location {
            display: none;
        }
        
        /* IMPRESSION */
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .nav-controls {
                display: none !important;
            }
            
            .calendar-page {
                width: 100%;
                height: auto;
                padding: 0;
                page-break-after: always;
                page-break-inside: avoid;
            }
            
            .calendar-page:last-child {
                page-break-after: auto;
            }
        }
        
        @page {
            size: A4 landscape;
            margin: 8mm;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="nav-controls">
        <div>
            <a href="{% url 'events:calendar_print' %}?mode={{ mode }}&year={{ prev_year }}&month={{ prev_month }}" class="btn-outline">
                <i class="bi bi-chevron-left"></i> Pr√©c√©dent
            </a>
            <a href="{% url 'events:calendar_print' %}?mode={{ mode }}&year={{ next_year }}&month={{ next_month }}" class="btn-outline">
                Suivant <i class="bi bi-chevron-right"></i>
            </a>
        </div>
        <div>
            <a href="{% url 'events:calendar_print' %}?mode=month&year={{ year }}&month={{ month }}" 
               class="btn-outline {% if mode == 'month' %}active{% endif %}">Mois</a>
            <a href="{% url 'events:calendar_print' %}?mode=quarter&year={{ year }}&month={{ month }}" 
               class="btn-outline {% if mode == 'quarter' %}active{% endif %}">Trimestre</a>
        </div>
        <div>
            <button onclick="window.print()" class="btn-success">
                <i class="bi bi-printer"></i> Imprimer
            </button>
            <a href="{% url 'events:calendar' %}" class="btn-outline">Retour</a>
        </div>
    </div>
    
    <!-- Calendriers - 1 page par mois -->
    {% for cal in calendars %}
    <div class="calendar-page {% if mode == 'quarter' %}quarter-mode{% endif %}">
        <div class="page-header">
            <h1>{{ cal.month_name }} {{ cal.year }}</h1>
            <span class="church">EEBC</span>
        </div>
        
        <table class="calendar-table">
            <thead>
                <tr>
                    {% for jour in jours_semaine %}
                    <th>{{ jour }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for week in cal.weeks %}
                <tr>
                    {% for day_data in week %}
                    {% if day_data.day %}
                    <td>
                        <div class="day-number">{{ day_data.day }}</div>
                        <div class="day-events">
                            {% for event in day_data.events|slice:":3" %}
                            <div class="event-item" style="background:{{ event.color }};">
                                <span class="event-time">{% if event.start_time %}{{ event.start_time|time:"H:i" }} {% endif %}</span>
                                <span class="event-title">{{ event.title|truncatechars:18 }}</span>
                                {% if event.location and mode != 'quarter' %}
                                <span class="event-location">üìç{{ event.location|truncatechars:15 }}</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% if day_data.events|length > 3 %}
                            <div class="more-events">+{{ day_data.events|length|add:"-3" }}</div>
                            {% endif %}
                        </div>
                    </td>
                    {% else %}
                    <td class="empty"></td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="legend">
            {% for category in categories %}
            <div class="legend-item">
                <div class="legend-color" style="background:{{ category.color }};"></div>
                <span>{{ category.name }}</span>
            </div>
            {% endfor %}
            <span style="margin-left:auto;">Imprim√© le {% now "d/m/Y" %}</span>
        </div>
    </div>
    {% endfor %}
</body>
</html>
