{% extends 'public/base.html' %}

{% block title %}Carte des églises - {{ settings.site_name|default:'EEBC' }}{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .leaflet-popup-content {
        min-width: 200px;
    }
    
    .popup-title {
        font-weight: bold;
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 8px;
    }
    
    .popup-info {
        margin: 5px 0;
        font-size: 0.9rem;
    }
    
    .popup-info i {
        width: 20px;
        color: var(--primary-color);
    }
    
    .map-legend {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
    }
    
    .legend-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .marker-church { background: #0A36FF; }
    .marker-family { background: #28a745; }
    .marker-event { background: #ffc107; }
</style>
{% endblock %}

{% block content %}
<section class="hero-section py-4">
    <div class="container text-center">
        <h1 class="display-5 fw-bold">Carte interactive</h1>
        <p class="lead">Localisez nos églises et événements</p>
    </div>
</section>

<section class="py-4">
    <div class="container">
        <div class="row">
            <div class="col-lg-9">
                <div id="map"></div>
            </div>
            <div class="col-lg-3">
                <!-- Légende -->
                <div class="map-legend mb-4">
                    <h5 class="mb-3">Légende</h5>
                    <div class="legend-item">
                        <div class="legend-marker marker-church"></div>
                        <span>Églises</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-event"></div>
                        <span>Événements</span>
                    </div>
                </div>
                
                <!-- Liste des sites -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Nos églises</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for site in sites %}
                        <a href="#" class="list-group-item list-group-item-action site-link" 
                           data-lat="{{ site.latitude }}" data-lng="{{ site.longitude }}"
                           data-name="{{ site.name }}">
                            <i class="bi bi-geo-alt me-2 text-primary"></i>
                            {{ site.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initialisation de la carte...');
    
    // Centre de la Guyane (Cayenne)
    const map = L.map('map').setView([4.9225, -52.3058], 11);
    
    // Couche OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    
    // Ajouter les marqueurs des sites directement
    {% for site in sites %}
    console.log('Ajout site: {{ site.name }}');
    L.marker([{{ site.latitude }}, {{ site.longitude }}])
        .bindPopup('<strong>{{ site.name|escapejs }}</strong><br>{{ site.address|escapejs }}<br>{{ site.city|escapejs }}')
        .addTo(map);
    {% empty %}
    console.log('Aucun site trouvé avec coordonnées GPS');
    {% endfor %}
    
    // Ajouter les marqueurs des événements
    {% for event in upcoming_events %}
    L.marker([{{ event.site.latitude }}, {{ event.site.longitude }}])
        .bindPopup('<strong>{{ event.title|escapejs }}</strong><br>{{ event.start_date|date:"d/m/Y" }}')
        .addTo(map);
    {% endfor %}
    
    console.log('Carte initialisée');
});
</script>
{% endblock %}
